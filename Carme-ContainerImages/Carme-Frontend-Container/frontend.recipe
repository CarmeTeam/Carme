BootStrap: debootstrap
OSVersion: stable
MirrorURL: http://ftp.de.debian.org/debian/

%help
    If you need any help you should ask the maintainer of this image.

%labels
    MAINTAINER CC-HPC Fraunhofer ITWM

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/opt/Carme

%files
    Carme-Frontend /opt/Carme/Carme-Frontend
    #Carme-Backend/SSL/frontend.crt /opt/Carme/Carme-Frontend/Carme-Django/webfrontend/SSL/
    #Carme-Backend/SSL/frontend.key /opt/Carme/Carme-Frontend/Carme-Django/webfrontend/SSL/

%post
    apt update
    apt upgrade -y

    # base stuff -------------------------------------------------------------------------------------------------------------------
    apt install -y vim nano less htop wget

    apt install -y apache2 apache2-bin apache2-data apache2-utils libapache2-mod-wsgi-py3
    a2enmod wsgi
    a2enmod expires

    chown -R www-data:www-data /opt/Carme/Carme-Frontend

    rm /etc/apache2/apache2.conf
    ln -s /opt/Carme/Carme-Frontend/Carme-Server-Conf/apache2/apache2.conf /etc/apache2/apache2.conf
    rm /etc/apache2/ports.conf
    ln -s /opt/Carme/Carme-Frontend/Carme-Server-Conf/apache2/ports.conf /etc/apache2/ports.conf
    rm /etc/apache2/sites-enabled/000-default.conf
    ln -s /opt/Carme/Carme-Frontend/Carme-Server-Conf/apache2/002-gpu.conf /etc/apache2/sites-enabled/002-gpu.conf

    # redirect apache logs
    rm -r /var/log/apache2
    ln -s /opt/Carme-Apache-Logs /var/log/apache2

    # install basig python libs
    apt install -y python3 python3-pip python3-dev python3-pyldap default-libmysqlclient-dev libsasl2-dev libldap2-dev libssl-dev

    # install python dependencies
    pip3 install mysqlclient numpy rpyc whitenoise wiki
    pip3 install Django
    pip3 install django-auth-ldap django-bootstrap-themes django-chartjs django-classy-tags django-db-logger django-filter django-js-asset django-logtailer django-maintenance-mode django-material django-mptt django-nyt django-sekizai django-settings-export django-viewflow django-todo

    # clean-up ---------------------------------------------------------------------------------------------------------------------
    apt autoremove -y 
    apt clean

%environment
    export XDG_RUNTIME_DIR=""

%runscript
    # migrate database
    /bin/bash -c "cd /opt/Carme/Carme-Frontend/Carme-Django/webfrontend && python3 manage.py migrate carme-base"

    # start webserver
    APACHE_STARTED_BY_SYSTEMD=1 apache2ctl start # APACHE_STARTED_BY_SYSTEMD=1 is required to ensure apache2 does not start his service via systemctl, because systemctl is not available in a singularity container

%startscript
    # migrate database
    /bin/bash -c "cd /opt/Carme/Carme-Frontend/Carme-Django/webfrontend && python3 manage.py migrate carme-base"

    # start webserver
    APACHE_STARTED_BY_SYSTEMD=1 apache2ctl start # APACHE_STARTED_BY_SYSTEMD=1 is required to ensure apache2 does not start his service via systemctl, because systemctl is not available in a singularity container
