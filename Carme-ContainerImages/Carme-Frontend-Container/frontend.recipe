BootStrap: debootstrap
OSVersion: stable
MirrorURL: http://ftp.de.debian.org/debian/

%help
    If you need any help you should ask the maintainer of this image.

%labels
    MAINTAINER CC-HPC Fraunhofer ITWM

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/opt/Carme
    mkdir -p ${SINGULARITY_ROOTFS}/etc/carme

%files 
    /opt/Carme/Carme-Frontend /opt/Carme/Carme-Frontend

%post  
    # update repos -----------------------------------------------------------------------------------------------------------------
    apt update
    apt upgrade -y
    #-------------------------------------------------------------------------------------------------------------------------------

    # install basic tools ----------------------------------------------------------------------------------------------------------
    apt install -y vim nano less htop wget curl
    #-------------------------------------------------------------------------------------------------------------------------------

    # install apache packages and update modules -----------------------------------------------------------------------------------
    apt install -y apache2 apache2-bin apache2-data apache2-utils libapache2-mod-wsgi-py3
    a2enmod wsgi
    a2enmod expires
    #-------------------------------------------------------------------------------------------------------------------------------

    # set up apache ----------------------------------------------------------------------------------------------------------------
    chown -R www-data:www-data /opt/Carme/Carme-Frontend

    rm -r /var/log/apache2
    rm /etc/apache2/ports.conf
    rm /etc/apache2/apache2.conf
    rm /etc/apache2/sites-enabled/000-default.conf
    
    ln -s /opt/Carme-Apache-Logs /var/log/apache2
    ln -s /opt/Carme/Carme-Frontend/Carme-Server-Conf/apache2/ports.conf /etc/apache2/ports.conf
    ln -s /opt/Carme/Carme-Frontend/Carme-Server-Conf/apache2/apache2.conf /etc/apache2/apache2.conf
    ln -s /opt/Carme/Carme-Frontend/Carme-Server-Conf/apache2/002-gpu.conf /etc/apache2/sites-enabled/002-gpu.conf
    #-------------------------------------------------------------------------------------------------------------------------------

    # install libs -----------------------------------------------------------------------------------------------------------------
    apt install -y python3 python3-pip python3-venv python3-dev  
    apt install -y python3-pyldap libsasl2-dev libldap2-dev
    apt install -y pkg-config default-libmysqlclient-dev
    apt install -y libssl-dev
    #-------------------------------------------------------------------------------------------------------------------------------

    # set up a python environment and install dependencies  ------------------------------------------------------------------------
    python3 -m venv /opt/.venv
    . /opt/.venv/bin/activate

    # python dependencies
    pip3 install Django numpy rpyc whitenoise requests mysqlclient django-mathfilters --no-cache-dir
    pip3 install misaka --no-cache-dir --use-pep517
    pip3 install django-auth-ldap django-two-factor-auth two_factor phonenumbers
   
    # source .venv as a singularity environment variable (needed to activate the environment inside the container)
    echo '. /opt/.venv/bin/activate' >> $SINGULARITY_ENVIRONMENT 
    #------------------------------------------------------------------------------------------------------------------------------

    # clean-up ---------------------------------------------------------------------------------------------------------------------
    apt autoremove -y 
    apt clean
    #-------------------------------------------------------------------------------------------------------------------------------

%environment
    export XDG_RUNTIME_DIR=""

%runscript 
    # migrate database
    /bin/bash -c "cd /opt/Carme/Carme-Frontend/Carme-Django/webfrontend && python3 manage.py migrate carme"

    # start webserver
    APACHE_STARTED_BY_SYSTEMD=1 apache2ctl start
    # APACHE_STARTED_BY_SYSTEMD=1 is required to ensure apache2 does not start his service via systemctl,
    # because systemctl is not available in a singularity container

%startscript
    # migrate database
    /bin/bash -c "cd /opt/Carme/Carme-Frontend/Carme-Django/webfrontend && python3 manage.py migrate carme"

    # start webserver
    APACHE_STARTED_BY_SYSTEMD=1 apache2ctl start
    # APACHE_STARTED_BY_SYSTEMD=1 is required to ensure apache2 does not start his service via systemctl,
    # because systemctl is not available in a singularity container
