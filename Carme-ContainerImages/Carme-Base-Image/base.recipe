BootStrap: debootstrap
OSVersion: stable
MirrorURL: http://ftp.de.debian.org/debian/


%help
  If you need any help you should ask the maintainer of this image.


%labels
  MAINTAINER Carme Team @ CC-HPC, Fraunhofer ITWM, GERMANY


%setup
    # hack to fix miniconda3 in singularity
  if [ -L /dev/shm ]; then
    if [ ! -d /run/shm ];then
      exit 1
    fi
    mkdir -p /dev/manual
    ln -s /dev/manual ${SINGULARITY_ROOTFS}/run/shm
    touch ${SINGULARITY_ROOTFS}/rm_run_shm
  fi

  mkdir "${SINGULARITY_ROOTFS}/opt/theia-ide"

%files
    includes/theia--package.json /opt/theia-ide/package.json
    includes/theia--index-html-fix.html /opt/theia-ide/index-html-fix.html
    includes/jupyterlab--overrides.json /opt/overrides.json
    includes/jupyterlab--page_config.json /opt/page_config.json

%post
  export TMPDIR="$(mktemp -d)"

  # update and upgrade repos -------------------------------------------------------------------------------------------------------
  apt update
  apt upgrade -y
  #---------------------------------------------------------------------------------------------------------------------------------

  # install basic programs
  apt install -y bash-completion htop less locales nano rsync shellcheck time unzip vim wget zip
  #---------------------------------------------------------------------------------------------------------------------------------


  # install dependencies of build tools
  apt install -y automake build-essential cmake colordiff fd-find fzf g++ gawk gawk gcc gdb gfortran git glances man-dbsed
  #---------------------------------------------------------------------------------------------------------------------------------


  # install openmpi
  apt install -y openmpi-bin
  #---------------------------------------------------------------------------------------------------------------------------------


  # install openssh for multi-node jobs and ssh-keygen
  apt install -y openssh-server
  #---------------------------------------------------------------------------------------------------------------------------------


  # install ib
  apt install -y libibverbs1 libibverbs-dev librdmacm1 libibmad5 libibumad3 librdmacm1 ibverbs-providers rdmacm-utils infiniband-diags libfabric1 ibverbs-utils
  #---------------------------------------------------------------------------------------------------------------------------------


  # regenerate locales
  echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
  dpkg-reconfigure --frontend=noninteractive locales
  #---------------------------------------------------------------------------------------------------------------------------------


  # install and configure mini-conda -----------------------------------------------------------------------------------------------
  cd /opt
  CONDA_INSTALL_PATH="/opt/miniconda3"
  wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  bash Miniconda3-latest-Linux-x86_64.sh -b -u -p "${CONDA_INSTALL_PATH}"
  rm Miniconda3-latest-Linux-x86_64.sh

  # activate conda
  . "${CONDA_INSTALL_PATH}/etc/profile.d/conda.sh"
  conda activate base

  # install theia.ide and basic plugins
  conda install -y -c conda-forge jupyterlab yarn=1 nodejs=10 nb_conda_kernels

  # apply jupyterlab settings modifications
  mkdir "${CONDA_DIR}/share/jupyter/lab/settings"
  mv /opt/overrides.json "${CONDA_DIR}/share/jupyter/lab/settings/overrides.json"
  mv /opt/page_config.json "${CONDA_DIR}/share/jupyter/lab/settings/page_config.json"
  #---------------------------------------------------------------------------------------------------------------------------------


  # install theia.ide --------------------------------------------------------------------------------------------------------------
  THEIA_DIR="/opt/theia-ide"
  cd "${THEIA_DIR}"

  apt install -y libsecret-1-dev
  yarn

  yarn theia build

  mv index-html-fix.html "lib/index.html"

  rm -r /usr/local/share/.cache
  #---------------------------------------------------------------------------------------------------------------------------------


  # build and install gpi2 ---------------------------------------------------------------------------------------------------------
  cd /opt
  git clone --branch v1.4.0 --depth 1 https://github.com/cc-hpc-itwm/GPI-2.git GPI-SRC

  cd /opt/GPI-SRC
  ./autogen.sh
  FC=gfortran CC=gcc CFLAGS="-fPIC" CPPFLAGS="-fPIC" ./configure --with-infiniband --prefix=/opt/GPI
  make -j 20
  make install
  cd
  rm -r /opt/GPI-SRC

  sed -i 's/GASPI_LAUNCHER="ssh"/GASPI_LAUNCHER="ssh -F ${CARME_SSHDIR}\/ssh_config"/g' /opt/GPI/bin/gaspi_run
  sed -i 's/ssh/ssh -F ${CARME_SSHDIR}\/ssh_config/g' /opt/GPI/bin/gaspi_cleanup

  ln -s /opt/GPI/bin/* /usr/local/bin/
  ln -s /opt/GPI/include/* /usr/local/include/
  mkdir -p /usr/local/lib64
  ln -s /opt/GPI/lib64/* /usr/local/lib64/
  rm /usr/local/lib64/pkgconfig
  mkdir -p /usr/local/lib64/pkgconfig
  ln -s /opt/GPI/lib64/pkgconfig/* /usr/local/lib64/pkgconfig
    #-------------------------------------------------------------------------------------------------------------------------------


  # clean up -----------------------------------------------------------------------------------------------------------------------
  conda clean --all -y
  apt autoremove --purge -y
  apt clean
  rm -r "${TMPDIR}"
  #---------------------------------------------------------------------------------------------------------------------------------


  # hack to fix miniconda3 in singularity ------------------------------------------------------------------------------------------
  if [ -f /rm_run_shm ];then
    rm /run/shm;
    rm /rm_run_shm
  fi
  #---------------------------------------------------------------------------------------------------------------------------------


%environment


%runscript
  echo "This is the CARME base-image singularity container (Debian)"
  echo "Containing basic software, miniconda, theia, jupyterlab, gpi and mpi"
