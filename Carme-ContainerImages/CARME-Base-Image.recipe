BootStrap: debootstrap
OSVersion: stable
MirrorURL: http://ftp.de.debian.org/debian/

%help
If you need any help you should ask the maintainer of this image.


%labels
MAINTAINER CC-HPC Fraunhofer ITWM
VERSION v1.0


%post
echo "deb http://ftp.de.debian.org/debian/ stable main contrib non-free" > /etc/apt/sources.list
echo "deb-src http://ftp.de.debian.org/debian/ stable main contrib non-free" >> /etc/apt/sources.list
echo "deb http://security.debian.org/ stable/updates main contrib non-free" >> /etc/apt/sources.list
echo "deb-src http://security.debian.org/ stable/updates main contrib non-free" >> /etc/apt/sources.list
echo "deb http://ftp.de.debian.org/debian stable-updates main contrib non-free" >> /etc/apt/sources.list
echo "deb-src http://ftp.de.debian.org/debian stable-updates main contrib non-free" >> /etc/apt/sources.list 

# update and upgrade ---------------------------------------------------------------------------------------------------------------
apt update
apt upgrade -y


# base stuff -----------------------------------------------------------------------------------------------------------------------
apt install -y automake bash-completion cmake colordiff fd-find fzf g++ gawk gcc gdb gfortran git glances htop less nano openmpi-bin openssh-server rsync shellcheck time unzip vim wget zip

# ib stuff
apt install -y libibverbs1 libibverbs-dev librdmacm1 libibmad5 libibumad3 librdmacm1 ibverbs-providers rdmacm-utils infiniband-diags libfabric1 ibverbs-utils


# set timezone ---------------------------------------------------------------------------------------------------------------------
rm /etc/localtime
ln -snf /usr/share/zoneinfo/Europe/Berlin /etc/localtime     # change to your preferred timezone
echo "Europe/Berlin" > /etc/timezone


# clean-up -------------------------------------------------------------------------------------------------------------------------
apt update
apt upgrade -y
apt autoremove -y 
apt clean


# reconfigure some stuff -----------------------------------------------------------------------------------------------------------
chmod 1777 /tmp
rm "/bin/sh"
ln -s "/bin/bash" "/bin/sh"
rm "/usr/share/man/man1/sh.1.gz"
ln -s "/usr/share/man/man1/sh.distrib.1.gz" "/usr/share/man/man1/sh.1.gz"


# conda stuff ----------------------------------------------------------------------------------------------------------------------
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -u -p /opt/anaconda3
rm Miniconda3-latest-Linux-x86_64.sh
  
. "/opt/anaconda3/etc/profile.d/conda.sh"
conda activate base
  
conda config --append channels conda-forge
conda update --all -y
conda update -y conda
conda install -y python=3.8.5
conda install -y -c conda-forge jupyterlab
conda install -y nb_conda_kernels
conda install -y -c conda-forge yarn=1.22.4 nodejs=10.16.3
conda clean --all -y


# theia (hard coded way) -----------------------------------------------------------------------------------------------------------
THEIA_DIR="/opt/theia-ide"
LOCAL_DIR="$(pwd)"
CONDA_DIR="/opt/anaconda3"

mkdir ${THEIA_DIR}
cd ${THEIA_DIR}

echo "{
 \"private\": true,
 \"dependencies\": {
   \"@theia/callhierarchy\": \"next\",
   \"@theia/file-search\": \"next\",
   \"@theia/git\": \"next\",
   \"@theia/keymaps\": \"next\",
   \"@theia/markers\": \"next\",
   \"@theia/messages\": \"next\",
   \"@theia/mini-browser\": \"next\",
   \"@theia/navigator\": \"next\",
   \"@theia/outline-view\": \"next\",
   \"@theia/plugin-ext-vscode\": \"next\",
   \"@theia/preferences\": \"next\",
   \"@theia/preview\": \"next\",
   \"@theia/search-in-workspace\": \"next\",
   \"@theia/terminal\": \"next\"
 },
 \"devDependencies\": {
   \"@theia/cli\": \"next\"
 },
 \"scripts\": {
   \"prepare\": \"yarn run clean && yarn build && yarn run download:plugins\",
   \"clean\": \"theia clean\",
   \"build\": \"theia build --mode development\",
   \"start\": \"theia start --plugins=local-dir:plugins\",
   \"download:plugins\": \"theia download:plugins\"
 },
 \"theiaPluginsDir\": \"plugins\",
 \"theiaPlugins\": {
   \"vscode-builtin-configuration-editing\": \"http://open-vsx.org/api/vscode/configuration-editing/1.47.3/file/vscode.configuration-editing-1.47.3.vsix\",
   \"vscode-builtin-cpp\": \"http://open-vsx.org/api/vscode/cpp/1.47.3/file/vscode.cpp-1.47.3.vsix\",
   \"vscode-builtin-css\": \"http://open-vsx.org/api/vscode/css/1.47.3/file/vscode.css-1.47.3.vsix\",
   \"vscode-builtin-debug-auto-launch\": \"http://open-vsx.org/api/vscode/debug-auto-launch/1.47.3/file/vscode.debug-auto-launch-1.47.3.vsix\",
   \"vscode-builtin-go\": \"http://open-vsx.org/api/vscode/go/1.47.3/file/vscode.go-1.47.3.vsix\",
   \"vscode-builtin-html\": \"http://open-vsx.org/api/vscode/html/1.47.3/file/vscode.html-1.47.3.vsix\",
   \"vscode-builtin-javascript\": \"http://open-vsx.org/api/vscode/javascript/1.47.3/file/vscode.javascript-1.47.3.vsix\",
   \"vscode-builtin-json\": \"http://open-vsx.org/api/vscode/json/1.47.3/file/vscode.json-1.47.3.vsix\",
   \"vscode-builtin-log\": \"http://open-vsx.org/api/vscode/log/1.47.3/file/vscode.log-1.47.3.vsix\",
   \"vscode-builtin-lua\": \"http://open-vsx.org/api/vscode/lua/1.47.3/file/vscode.lua-1.47.3.vsix\",
   \"vscode-builtin-make\": \"http://open-vsx.org/api/vscode/make/1.47.3/file/vscode.make-1.47.3.vsix\",
   \"vscode-builtin-markdown\": \"http://open-vsx.org/api/vscode/markdown/1.47.3/file/vscode.markdown-1.47.3.vsix\",
   \"vscode-builtin-merge-conflict\": \"http://open-vsx.org/api/vscode/merge-conflict/1.47.3/file/vscode.merge-conflict-1.47.3.vsix\",
   \"vscode-builtin-perl\": \"http://open-vsx.org/api/vscode/perl/1.47.3/file/vscode.perl-1.47.3.vsix\",
   \"vscode-builtin-python\": \"http://open-vsx.org/api/vscode/python/1.47.3/file/vscode.python-1.47.3.vsix\",
   \"vscode-builtin-r\": \"http://open-vsx.org/api/vscode/r/1.47.3/file/vscode.r-1.47.3.vsix\",
   \"vscode-builtin-ruby\": \"http://open-vsx.org/api/vscode/ruby/1.47.3/file/vscode.ruby-1.47.3.vsix\",
   \"vscode-builtin-shellscript\": \"http://open-vsx.org/api/vscode/shellscript/1.47.3/file/vscode.shellscript-1.47.3.vsix\",
   \"vscode-builtin-sql\": \"http://open-vsx.org/api/vscode/sql/1.47.3/file/vscode.sql-1.47.3.vsix\",
   \"vscode-builtin-xml\": \"http://open-vsx.org/api/vscode/xml/1.47.3/file/vscode.xml-1.47.3.vsix\",
   \"vscode-builtin-yaml\": \"http://open-vsx.org/api/vscode/yaml/1.47.3/file/vscode.yaml-1.47.3.vsix\",
   \"vscode-editorconfig\": \"https://open-vsx.org/api/EditorConfig/EditorConfig/0.15.1/file/EditorConfig.EditorConfig-0.15.1.vsix\",
   \"vscode-references-view\": \"http://open-vsx.org/api/ms-vscode/references-view/0.0.47/file/ms-vscode.references-view-0.0.47.vsix\",
   \"vscode-shellcheck\": \"https://open-vsx.org/api/timonwong/shellcheck/0.9.0/file/timonwong.shellcheck-0.9.0.vsix\",
   \"vscode-sortlines\": \"https://open-vsx.org/api/Tyriar/sort-lines/1.9.0/file/Tyriar.sort-lines-1.9.0.vsix\"
 }
}
" > package.json

echo "<!DOCTYPE html>
<html>

<head>
  <meta charset=i\"UTF-8\">
  <script type=\"text/javascript\">
    var elBase = document.createElement('base');
    elBase.href = document.location.origin + document.location.pathname + '/';
    document.head.appendChild(elBase);

    var elScript = document.createElement('script');
    elScript.type = 'text/javascript';
    elScript.src = './bundle.js';
    document.head.appendChild(elScript);
  </script>
</head>

<body>
  <div class=\"theia-preload\"></div>
</body>

</html>
" > index-html-fix.html

apt install -y python2.7-minimal
ln -s "/usr/bin/python2.7" "${THEIA_DIR}/python"

PATH="${THEIA_DIR}:${PATH}" yarn
PATH="${THEIA_DIR}:${PATH}" yarn theia build
cp index-html-fix.html "lib/index.html"

cd /opt
chmod 777 ${THEIA_DIR}

rm -r /tmp/*
apt purge -y python2.7-minimal
rm "${THEIA_DIR}/python"
apt autoremove --purge -y
apt clean


# build gpi ------------------------------------------------------------------------------------------------------------------------
cd /opt
git clone https://github.com/cc-hpc-itwm/GPI-2.git GPI-SRC
cd /opt/GPI-SRC
./autogen.sh
CC=gcc FC=gfortran ./configure --with-infiniband --prefix=/opt/GPI
make -j 20
make install
cd
rm -r /opt/GPI-SRC

cd /opt/GPI/bin
sed -i 's/GASPI_LAUNCHER="ssh"/GASPI_LAUNCHER="ssh -F ${CARME_SSHDIR}\/ssh_config"/g' gaspi_run 
sed -i 's/\/tmp\//${TMP}\//g' gaspi_run
cd
ln -s /opt/GPI/bin/gaspi_cleanup /usr/local/bin/gaspi_cleanup
ln -s /opt/GPI/bin/gaspi_logger /usr/local/bin/gaspi_logger
ln -s /opt/GPI/bin/gaspi_run /usr/local/bin/gaspi_run
ln -s /opt/GPI/bin/ssh.spawner /usr/local/bin/ssh.spawner
ln -s /opt/GPI/include /usr/local/include/GPI
ln -s /opt/GPI/lib64 /usr/local/lib/GPI


%environment


%runscript
echo "This is the CARME base-image singularity container (Debian)"
echo "Containing basic software, miniconda, theia, jupyterlab, gpi and mpi"

