{% extends 'base.html' %}

{% comment %}
# ----------------------------------------------
# Carme
# ----------------------------------------------
# home.html
#
# see Carme development guide for documentation:
# * Carme/Carme-Doc/DevelDoc/CarmeDevelopmentDocu.md
#
# Copyright 2019 by Fraunhofer ITWM
# License: http://open-carme.org/LICENSE.md
# Contact: info@open-carme.org
# ---------------------------------------------
{% endcomment %}

{% load static %}
{% load timetags %}

{% block title %}Carme Home{% endblock %}

{% block content %}
<div class="container my-4">
	<div class="card-deck">
		<div class="card mb-4">
			<div class="card-header font-weight-bold"><i class="fa fa-newspaper-o fa-fw" aria-hidden="true"></i>&nbsp; News</div>
			<div class="card-body" style="height: 300px;">
						
			</div>
		</div>
		<div class="w-100 d-none d-sm-block d-md-none"><!-- wrap every 3 on md--></div>
		<div class="card mb-4">
			<div class="card-header font-weight-bold"><i class="fa fa-area-chart fa-fw" aria-hidden="true"></i>&nbsp; Status</div>
			<div class="card-body" style="height: 300px;">
				
			</div>
		</div>
		<div class="w-100 d-none d-md-block d-lg-none"><!-- wrap every 3 on md--></div>
		<div class="w-100 d-none d-sm-block d-md-none"><!-- wrap every 3 on md--></div>
		<div class="card mb-4">
			<div class="card-header font-weight-bold"><i class="fa fa-envelope-o fa-fw" aria-hidden="true"></i>&nbsp; Messages</div>
			<div class="card-body" style="height: 300px; overflow-y: scroll;">
				<div id="messages"class="card-text">
					{% include "blocks/messages.html" %}
				</div>
			</div>
		</div>
	</div>


          <!-- <middle layer> -->
          <div class="row mt-2">
            <div class="col-12">
              <div class="card-deck">

                  <!-- <jobs history> -->
                  <div class="card mb-4">
                    <div class="card-header bg-light">
                      <div class="row align-items-center">
                        <div class="col">
                          <h6 class="mb-0 style-title"><i class="fa fa-history" aria-hidden="true"></i> History</h6>
                        </div>
                        <div class="col-auto text-center pe-card" class"form-select">
                          <button type="button" class="btn btn-outline-secondary custom-btn" data-toggle="modal" data-target="#exampleModal">
                            More details
                          </button>
                          <!-- <modal> -->
                          <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                              <div class="modal-content">
                                <div class="modal-header bg-light">
                                  <h5 class="modal-title" id="exampleModalLabel"><i class="fa fa-history" aria-hidden="true"></i>  History</h5>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                  </button>
                                </div>
                                <div class="modal-body">
                                  {% include "blocks/jobhistory.html" %} 
                                </div>
                                <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- </modal> -->
                        </div>
                      </div>
                    </div>
                    <div class="card-body" style="height: 320px;">
                      {% comment %} <div style="display: block;"> {% endcomment %}
                        <div class="table-responsive scrollbar">
                          <table class="table table-sm table-striped mb-0 overflow-hidden text-center">
                            <thead>
                              <tr>
                                <th class="align-middle style-text">ID</th>
                                <th class="align-middle style-text" style="min-width: 6.0rem;">Submitted<br> Ended</th>
                                <th class="align-middle style-text">Image</th>
                                <th class="align-middle style-text">nodes</th>
                                <th class="align-middle style-text"><span class="frac"><sup>CPUs</sup><span>&frasl;</span><sub>node</sub></span></th>
                                <th class="align-middle style-text" style="min-width: 6.0rem;"><span class="frac"><sup>GPUs</sup><span>&frasl;</span><sub>node</sub></span></th>
                                <th class="align-middle"></th>
                              </tr>
                            </thead>
                            <tbody class="list" id="table-orders-body">
                              {% if myjobhist %}
                                {% for job, slurm in mylist_short %}
                                <tr> 
                                  <td class="py-1 align-middle">
                                      <p class="pt-3 style-text text-underline" data-container="body" data-toggle="popover" data-html="true"  data-placement="left" data-trigger="hover" 
                                      data-content=' 
                                        <span class="style-text">Name:<span> <span class="pl-3 style-text">{{job.job_name}} </span> <br>
                                        <hr class="my-1">
                                        <span class="style-text">Node:</span> <span class="pl-3 style-text">&nbsp;{{ job.nodelist }}</span> <br>
                                        <hr class="my-1">
                                        <span class="style-text">Partition:</span> <span class="pl-1 style-text">{{ job.partition }}</span> <br>
                                        <hr class="my-1">
                                        <span class="style-text">Memory:</span> <span class="pl-1 style-text"> {{ job.mem_req }}</span> <br>
                                        <hr class="my-1">
                                        <span class="style-text">Exit code:</span> {{ job.exit_code }} '>{{ job.id_job }}
                                      </p> 
                                  </td>
                                  <td class="py-1 align-middle style-text">
                                    <p class="mb-0">{{ job.time_submit | print_timestamp_small }}</p>
                                    <p class="mb-0">{{ job.time_end | print_timestamp_small }}</p>
                                  </td>
                                  <td class="py-1 align-middle">
                                    <div class="style-text">
                                      {{ slurm.image_name | truncatechars:10}}
                                    </div>
                                  </td>
                                  <td class="py-1 align-middle">
                                    <span class="i-node">{{ job.nodes_alloc}}</span>
                                  </td>
                                  <td class="py-1 align-middle">
                                    <span class="i-cpu">{{ job.cpus_req }}</span>
                                  </td>
                                  <td class="py-1 align-middle">
                                    <span class="i-gpu">{{slurm.num_gpus}}</span> <span class="i-gpu-text">{{ slurm.gpu_type | upper }}</span>
                                  </td>
                                  <td class="py-1 align-middle">
                                    <button type="button" class="btn btn-outline-danger"><i class="fa fa-repeat" aria-hidden="true"></i></button>
                                  </td>
                                </tr>
                                {% endfor %}
                              {% else %}
                                <tr>
                                  <td class="py-2 align-middle style-text">Jobs history is empty</td>
                                </tr>
                              {% endif %}
                            </tbody>
                          </table>  
                        </div>
                      {% comment %} </div> {% endcomment %}
                    </div>
                  </div>
                  <!-- </jobs history> -->

                  <div class="w-100 d-none d-sm-block d-lg-none"><!-- only visible in sm and md --></div>
                  
                  <!-- <cluster chart> -->
                  <div class="card mb-4">
                    <div class="card-header bg-light">
                      <div class="row align-items-center">
                        <div class="col">
                          <h6 class="mb-0 style-title"><i class="fa fa-area-chart" aria-hidden="true"></i> Chart</h6>
                        </div>
                        <div class="col-auto text-center pe-card">
                          <select class="form-select form-select-sm" id="listchart">
                            <option value="time" selected>Time chart</option>
                            <option value="forecast">Forecast</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="card-body ml-4 mr-4 px-0 pb-1" style="height: 320px;">
                      <div id="optionchart-time" class="optionchart" style="display: block;">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                          {% if CARME_GPU_TYPE_LIST|length > 1 %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="timechart-tab" data-toggle="tab" href="#timechart" role="tab" aria-controls="timechart" aria-selected="true">Total</a>
                            </li>
                            {% for gpu in CARME_GPU_TYPE_LIST %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="time-gpu{{forloop.counter}}-tab" data-toggle="tab" href="#time-gpu{{forloop.counter}}" role="tab" aria-controls="time-gpu{{forloop.counter}}" aria-selected="false">{{ CARME_GPU_TYPE_LIST | index:forloop.counter0 | upper }}</a>
                            </li>
                            {% endfor %}
                          {% elif  CARME_GPU_TYPE_LIST|length == 1 %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="timechart-tab" data-toggle="tab" href="#timechart" role="tab" aria-controls="timechart" aria-selected="true">{{ CARME_GPU_TYPE_LIST | index:0 | upper }}</a>
                            </li>
                          {% else %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="timechart-tab" data-toggle="tab" href="#timechart" role="tab" aria-controls="timechart" aria-selected="true">NONE</a>
                            </li>
                          {% endif %}
                        </ul>

                        <div class="tab-content" id="myTabContent">
                          {% if CARME_GPU_TYPE_LIST|length > 1 %}
                            <div class="tab-pane fade show active" id="timechart" role="tabpanel" aria-labelledby="timechart-tab">
                              <div id="myTimeChart" style="height: 230px;" class="ml-0 mr-2"></div>
                            </div>
                            {% for gpu in CARME_GPU_TYPE_LIST %}
                            <div class="tab-pane fade" id="time-gpu{{forloop.counter}}" role="tabpanel" aria-labelledby="time-gpu{{forloop.counter}}-tab">
                              {{ CARME_GPU_TYPE_LIST | index:forloop.counter0 }}-TIME
                            </div>
                            {% endfor %}
                          {% elif  CARME_GPU_TYPE_LIST|length == 1 %}
                            <div class="tab-pane fade show active" id="timechart" role="tabpanel" aria-labelledby="timechart-tab">
                              <div id="myTimeChart" style="height: 230px;" class="ml-0 mr-2"></div>
                            </div>
                          {% else %}
                            <div class="tab-pane fade show active" id="timechart" role="tabpanel" aria-labelledby="timechart-tab">
                              GPU_TYPE is empty
                            </div>
                          {% endif %}
                        </div>
                      </div>

                      <div id="optionchart-forecast" class="optionchart">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                          {% if CARME_GPU_TYPE_LIST|length > 1 %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="forecastchart-tab" data-toggle="tab" href="#forecastchart" role="tab" aria-controls="forecastchart" aria-selected="true">Total</a>
                            </li>
                            {% for gpu in CARME_GPU_TYPE_LIST %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link" id="forecast-gpu{{forloop.counter}}-tab" data-toggle="tab" href="#forecast-gpu{{forloop.counter}}" role="tab" aria-controls="forecast-gpu{{forloop.counter}}" aria-selected="false">{{ CARME_GPU_TYPE_LIST | index:forloop.counter0 | upper }}</a>
                            </li>
                            {% endfor %}
                          {% elif  CARME_GPU_TYPE_LIST|length == 1 %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="forecastchart-tab" data-toggle="tab" href="#forecastchart" role="tab" aria-controls="forecastchart" aria-selected="true">{{ CARME_GPU_TYPE_LIST | index:0 | upper }}</a>
                            </li>
                          {% else %}
                            <li class="nav-item" role="presentation">
                              <a class="nav-link active" id="forecastchart-tab" data-toggle="tab" href="#forecastchart" role="tab" aria-controls="forecastchart" aria-selected="true">NONE</a>
                            </li>
                          {% endif %}
                        </ul>
                        <div class="tab-content " id="myTabContent">
                          {% if CARME_GPU_TYPE_LIST|length > 1 %}
                            <div class="tab-pane fade show active" id="forecastchart" role="tabpanel" aria-labelledby="forecastchart-tab">
                              <div id="myForecastChart0" style="height: 250px;" class="mr-2 pr-2"></div>
                            </div>
                            {% for gpu in CARME_GPU_TYPE_LIST %}
                            <div class="tab-pane fade" id="forecast-gpu{{forloop.counter}}" role="tabpanel" aria-labelledby="forecast-gpu{{forloop.counter}}-tab">
                              <div id="myForecastChart{{forloop.counter}}" style="height: 250px;" class="mr-2 pr-2"></div>
                            </div>
                            {% endfor %}
                          {% elif  CARME_GPU_TYPE_LIST|length == 1 %}
                            <div class="tab-pane fade show active" id="forecastchart" role="tabpanel" aria-labelledby="forecastchart-tab">
                              <div id="myForecastChart0" style="height: 250px;" class="mr-2 pr-2"></div>
                            </div>
                          {% else %}
                            <div class="tab-pane fade show active" id="forecastchart" role="tabpanel" aria-labelledby="forecastchart-tab">
                              GPU_TYPE is empty
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- </cluster chart> -->

              </div>
            </div>
          </div>
          <!-- </middle layer> -->
										
 									<!-- <bottom layer> -->
										<div class="row mt-2">
											<div class="col-12">
												<div class="card-deck">
													<div class="card mb-4">
														<div class="card-header bg-light">
															<div class="row align-items-center">
																<div class="col">
																	<h6 class="mb-0 style-title"><i class="fa fa-tasks" aria-hidden="true"></i> Jobs</h6>
																</div>
															</div>
														</div>
														<div class="card-body">
															<div class="mt-2 table-responsive">
																<table class="table table-striped mb-0 overflow-hidden text-center style-text">
																	<thead>
																		<tr>
                   <form class="form ajax" action="{% url 'start_job' %}" method="post">
                    {% csrf_token %}
                    <div class="form-row">

                    	<th scope="col" class="align-middle" colspan="2" style="min-width: 10rem;">
                     	<div class="input-group my-1 align-middle">
                      	<div class="input-group-prepend">
                       	<span class="input-group-text style-text" id="inputGroup-sizing-default">{{ start_job_form.nodes.label }}</span> 
                       </div>
                       <select name="{{ start_job_form.nodes.html_name }}" class="custom-select style-text">
                       	{% for choice in start_job_form.nodes.field.choices %}
                        	<option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %} 
                       </select>
                      </div>
                     </th>

                     <th scope="col" class="align-middle" colspan="2" style="min-width: 12.2rem;">
                      <div class="input-group my-1">
                       <div class="input-group-prepend">
                        <span class="input-group-text style-text" id="inputGroup-sizing-default">{{ start_job_form.gpu_type.label }}</span>
                       </div>
                       <select name="{{ start_job_form.gpu_type.html_name }}" class="custom-select style-text">
                        {% for choice in start_job_form.gpu_type.field.choices %}
                         <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %}
                       </select> 
                      </div>
                     </th>

                     <th scope="col" class="align-middle" colspan="2" style="min-width: 11.3rem;">
                      <div class="input-group my-1">
                       <div class="input-group-prepend">
                        <span class="input-group-text style-text" id="inputGroup-sizing-default">{{ start_job_form.gpus.label }}</span>
                       </div>
                       <select name="{{ start_job_form.gpus.html_name }}" class="custom-select style-text">
                        {% for choice in start_job_form.gpus.field.choices %}
                         <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %}
                       </select>
                      </div>
                     </th>

                     <th scope="col" class="align-middle" colspan="2">
                      <div class="input-group my-1">
                       <div class="input-group-prepend">
                        <span class="input-group-text style-text" id="inputGroup-sizing-default">{{ start_job_form.image.label }}</span>
                       </div>
                       <select name="{{ start_job_form.image.html_name }}" class="custom-select style-text">
                        {% for choice in start_job_form.image.field.choices %}
                         <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endfor %}
                       </select>
                      </div>
                     </th>

                     <th scope="col" class="align-middle" colspan="2">
                     	<div class="input-group my-1">
                       <div class="input-group-prepend">
                        <span class="input-group-text style-text" id="inputGroup-sizing-default">{{ start_job_form.name.label }}</span>
                       </div>
                       <input type="text" name="{{ start_job_form.name.html_name }}" class="form-control style-text" aria-label="Sizing example input"
                        	aria-describedby="inputGroup-sizing-default" value="{{ start_job_form.name.field.initial }}">
                      </div>
                     </th>
                                  
                     <th scope="col" class="align-middle">
                      <button class="btn btn-primary start-job" type="submit"><i class="fa fa-play fa-fw" aria-hidden="true"></i></button>
                     </th>

                    </div>
                   </form>
                  </tr>

																		<tr>
                   <th scope="col" class="align-middle">ID</th>
                   <th scope="col" class="align-middle">Name</th>
                   <th scope="col" class="align-middle">Image</th>
                   <th scope="col" class="align-middle">Nodes</th>
                   <th scope="col" class="align-middle">
																					<span class="frac">
																							<sup>CPUs</sup>
																							<span>&frasl;</span>
																							<sub>node</sub>
																					</span>
																			</th>
					              <th scope="col" class="align-middle" style="min-width: 6.0rem;">
																					<span class="frac">
																							<sup>GPUs</sup>
																							<span>&frasl;</span>
																							<sub>node</sub>
																					</span>
																			</th>
                   <th scope="col" class="align-middle">Status</th>
                   <th scope="col" class="align-middle">Timing</th>
                   <th scope="col" class="align-middle">Entry points</th>
                   <th scope="col" class="align-middle">Details</th>
                   <th scope="col" class="align-middle">Stop</th>
                  </tr>
																	</thead>
																	<tbody id="jobtable">
																		{% include "blocks/job_table.html" %}
																	</tbody>
																</table>
															</div><!--</table responsive>-->
														</div><!--</card-body>-->
													</div><!--</card mb-4>-->
												</div><!--</card-deck>-->
											</div><!--</col>-->
										</div><!--</row>-->
										{% endblock %}

{% block javascript %}
{% comment %}  <script src="{% static 'js/jquery.min.js' %}"></script> {% endcomment %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script type="text/javascript" src="{% static 'js/chart.min.js' %}"></script>

<script type="text/javascript">
		if (!$) console.error('jQuery is required!');
		else {
			$(document).on('submit', 'form.ajax', function (event) {
				// source: https://www.sanwebe.com/2016/07/ajax-form-submit-examples-using-jquery
				event.preventDefault(); //prevent default action

				var post_url = $(this).attr("action"); //get form action url
				var request_method = $(this).attr("method"); //get form GET/POST method
				var form_data = $(this).serialize(); //Encode form elements for submission

				$.ajax({
					url: post_url,
					type: request_method,
					data: form_data
				}).fail(function () {
					console.error('Request to ' + post_url + ' failed. Please try again.');
				}).always(function () {
					setTimeout(function () {
						//document.location.reload();
					}, 1000);
				});
			});
		}
</script>

<script>
	$("[data-toggle=popover]").popover({
		container: "body" 
	});
</script>

<script>
	$("ul.nav-tabs a").click(function (e) {
 		e.preventDefault();
  	$(this).tab('show');
  });
</script>

<script>
	var $list = $( '#listchart' );
	var $options = $( '.optionchart' );
	
	$list.on( 'change', function ( e ) {
 	$options.hide();
  $( '#optionchart-' + this.value ).show(); 
 });
</script>

{% include "blocks/forecast.html" %}

<script type="text/javascript">
	if (!$) console.error('jQuery is required!');
	else {
		function update_chart() {
												Highcharts.seriesTypes.areaspline.prototype.drawLegendSymbol = Highcharts.seriesTypes.line.prototype.drawLegendSymbol;
            $.get('{% url 'line_chart_json_time' %}', function (data) {
                data["chart"] = {
                    type: "areaspline"
                };

                data["title"] = {                                                                                                                                                                      
                    text: "",                                                                                                                                                                          
                };   

                data["plotOptions"] = {
                  areaspline: {
                      fillOpacity: 0.2
                  }
                };

                data["legend"] = {
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'top',
                    floating: false,
                };

                $("#myTimeChart").highcharts(data);
            });			
		}
  
		
		function update_news() {
			$.ajax('/wiki/cluster_news/', {
				type: "GET",
				statusCode: {
					401: function (response) {
						window.location = '/login/?next=' + window.location.pathname + '&timeout=1';
					}
				}, success: function (data) {
					var content_reg = /<body.*?>([\S\s]*?)(?:<\/body>)/gmi;
					var match = content_reg.exec(data);

					if(match && match.length > 1) {
						document.getElementById('news').innerHTML = $(match[1]).find('.wiki-article').first().html();
					}
				}
			});
		}

		function update_messages() {
			$.ajax('/carme/Messages/',{
				type: "GET",
				statusCode: {
					401: function (response) {
						window.location = '/login/?next=' + window.location.pathname + '&timeout=1';
					}
				}, success: function (data) {
					var entries = $(data);
					
					entries.each(function( index ) {
						var msgid = $(this).data('msgid');
						var existing = $('#messages div[data-msgid="' + msgid + '"]');

						if(existing.length == 0) {
							// message not existing, prepend element
							$('#messages').prepend($(this));
						}
					});
				}
			});
		}

		function update_jobtable() {
			$.ajax('/carme/JobTable/',{
				type: "GET",
				statusCode: {
					401: function (response) {
						window.location = '/login/?next=' + window.location.pathname + '&timeout=1';
					}
				}, success: function (data) {
					var entries = $(data);

					entries.each(function( index ) {
						var jobid = $(this).data('jobid');
						var existing = $('#jobtable tr[data-jobid="' + jobid + '"]');



						if(existing.length > 0) {
							if($(this).text() == existing.text()) {
								// content equals, just update csrf
								var newTokens = $(this).find('input[name="csrfmiddlewaretoken"]');
									existing.find('input[name="csrfmiddlewaretoken"]').each(function(index) {
									$(this).val(newTokens[index].value);
								});
							} else {
								// content changed, replace element
								$(this).replaceAll(existing);
							}
						} else {
							// job not existing, remove element
							$('#jobtable').append($(this));
						}
					});

					var sel = $(data).map(function() {
						var jobid = $(this).data('jobid');
						return 'tr[data-jobid="' + jobid + '"]';
					}).get().join(',');

					$('#jobtable tr').not(sel).remove();
				}
			});
		}

		update_chart();
		update_news();

		setInterval(function () {
			update_jobtable();
			update_messages();
		}, 2000);

		setInterval(function () {
			update_chart();
		}, 1000 * 60 * 5);

		$( document ).on( "click", "button.start-job,button.stop-job", function() {
			setTimeout(function() {
				update_messages();
				update_jobtable();
			}, 175);
		});
	}
</script>
{% endblock %}
