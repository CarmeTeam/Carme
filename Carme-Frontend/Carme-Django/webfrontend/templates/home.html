<!---
								# ---------------------------------------------- 
								# Carme
								# ----------------------------------------------
								# home.html                                                                                                                                                                      
								#               
								# see Carme development guide for documentation: 
								# * Carme/Carme-Doc/DevelDoc/CarmeDevelopmentDocu.md
								#
								# Copyright 2019 by Fraunhofer ITWM  
								# License: http://open-carme.org/LICENSE.md 
								# Contact: info@open-carme.org
								# ---------------------------------------------
-->

{% extends 'base.html' %}
{% load static %}
{% load staticfiles %} 
{% block title %}Carme Home{% endblock %}
{% block content %}

<!-- <meta http-equiv="refresh" content="60" /> -->
{% if user.is_authenticated %}

{% include "blocks/maintenance.html" %}
<div class="double-container">
								<div class="news-container">
																<div>
																								<h3>
																																<img src="{% static "info.jpg" %}" style="width:1.1em;"/>
																																Cluster News
																								</h3>
																</div>
																<div id="news" style="height: 200px; border: 0px solid #D5CC5A; overflow-y: scroll; margin: 15px auto; "></div>
								</div>
								<div class="double-space"></div>
								<div class="news-container">
																<div >
																								<h3>
																																<img src="{% static "status2.jpg" %}" style="width:1.1em;"/> 
																																Status 
																								</h3>
																								<div class="chart-container" style="position: relative; height:15vh; width:20vw"> 							
																																<canvas id="myChart" ></canvas>
																								</div> 
																								<script type="text/javascript" src="{% static 'js/Chart.min.js' %}"></script>
																								<script type="text/javascript"> 
$.get('{% url 'line_chart_json' %}', function(data) {
								var ctx = $("#myChart").get(0).getContext("2d");  
								new Chart(ctx, { 
																type: 'line', data: data, 
																options: {
																								scales: {
																																xAxes: [{
																																								ticks: {
																																																display: true //this will remove only the label
																																								},
																																								scaleLabel: { 
																																																labelString: 'time',
																																																display: false
																																								}

																																}],
																																yAxes: [{
																																								stacked: true,
																																								scaleLabel: {
																																														labelString: '#GPUs (stacked)',
																																														display: true
																																								}

																																}]							
																								},
																								elements: {
																																line: {
																																								tension: 1, // disables bezier curves
																																								}
																										        }

																}	
								});      
});
																								</script>   
																</div>

								</div>
								<div class="double-space"></div>
								<div class="news-container">
																<div > 
																								<h3> 
																																<img src="{% static "warning.jpg" %}" style="width:1.1em;"/> 
																																Messages   
																								</h3> 
																</div>
															 <div id="messages" style="height: 200px; border: 0px solid #D5CC5A; overflow-y: scroll; margin: 15px auto; padding: 5px;"></div>

								</div>           
</div>
<BR>
<div class="main-container">

								{% include "blocks/start_job.html" %} 
								<div id="jobtable" style="border: 0px solid #D5CC5A; overflow: hidden; margin: 15px auto; "></div>
</div>
<BR>
{% if user.is_superuser %}
{% include "blocks/admin_footer.html" %} 
<BR>  
{% endif %}
{% include "blocks/footer.html" %}
{% else %}
<div class="main-container">
								<h2>{{ settings.CARME_FRONTEND_TITLE }}</h2>
								Cluster Access is ristricted to authorized users.<BR><BR>
								Please <a href="{% url 'login' %}"><b>LOG IN</b></a>
</div>
{% endif %}

<script type="text/javascript">
if(!$) console.error('jQuery is required!');
else {
	function update_content(url, id) {
		var elem = document.getElementById(id);

		if(!elem) return console.error('No element found to update content!');

		$.get(url, function(data) {
			var timeout_reg = /Session time out!/gmi;
			var timeout_match = timeout_reg.exec(data);

			if(timeout_match) {
				return window.location = '/login/?next=' + window.location.pathname + '&timeout=1';
			}
			
			var content_reg;

			if(id == 'messages' || id == 'jobtable') {
				content_reg = /<body>([\S\s]*?)(?:<\/body>)/gmi;
			} else if(id == 'news') {
				content_reg = /<div class="wiki-article">([\S\s]*?)(?:<\/div>)/gmi;
			}

			var match = content_reg.exec(data);

			if(!match) return console.error('No match in ajax response to update content!');

			elem.innerHTML = match[1];
		});
	}

	update_content('/carme-base/JobTable/', 'jobtable');
	update_content('/carme-base/Messages/', 'messages');
	update_content('/wiki/cluster_news/', 'news');

	setInterval(function() {
		update_content('/carme-base/JobTable/', 'jobtable');
		update_content('/carme-base/Messages/', 'messages');
	}, 2000);

	$(document).on('submit', 'form.ajax', function (event) {
		// source: https://www.sanwebe.com/2016/07/ajax-form-submit-examples-using-jquery
		event.preventDefault(); //prevent default action

		var post_url = $(this).attr("action"); //get form action url
		var request_method = $(this).attr("method"); //get form GET/POST method
		var form_data = $(this).serialize(); //Encode form elements for submission
		
		$.ajax({
			url : post_url,
			type: request_method,
			data : form_data
		}).fail(function(){
			console.error('Request to ' + post_url + ' failed. Please try again.');
		}).always(function() {
			update_content('/carme-base/JobTable/', 'jobtable');
			update_content('/carme-base/Messages/', 'messages');
		});
	});
}
</script>

{% endblock %}
