{% extends "projects/project_base.html" %}

{% block title %}Projects{% endblock title %}

{% block project_content %}
<div class="row mt-2 mb-4">
	<div class="col">
 	<div class="card">
				
   <!-- <card-header> -->
			<div class="card-header">
				<div class="row align-items-center">
														
					<div class="col">
						<h5 class="mb-0 py-2 fs-0 fw-400 text-header">
							<i class="fas fa-diagram-project"></i> My Projects
						</h5>
					</div>
						
					<div class="col-auto text-center pe-card" class"form-select form-select-sm">
						{% if user.is_authenticated %}
							<a href="{% url 'projects:create' %}">
								<button type="button" class="btn btn-sm btn-outline-secondary custom-btn" style="width:105px;">
									<span class="p-1 fs--1 fw-400 text-header">New Project </span>
								</button>
							</a>
						{% endif %}  
					</div>
						
				</div>
			</div>
   <!-- </card-header> -->

   <!-- <card-body> -->
   <div class="card-body">
					
				<!-- <join-project> -->
				<form onSubmit="return JoinProjectURL();">
					{% csrf_token %} 
					<div class="input-group mb-3">
						<input type="text" id="project-url" name="project-url" class="form-control fs-0 fw-400 text-body" placeholder="Type the project ID to join">
						<button type="submit" class="btn btn-sm btn-outline-secondary custom-btn" style="width:105px;">
						 <span class="p-1 fs--1 fw-400 text-body">Join Project</span>
						</button>
					</div>
				</form>
				
				{% if messages %}
					{% for message in messages %}
						<div {% if message.tags %}  id="{{ message.tags }}-message" {% endif %} class="alert alert-danger py-2" role="alert">
							<i class="fas fa-times-circle"></i>&nbsp; {{ message }}
						</div>
					{% endfor %}
				{% endif %}
				<!-- </join-project> -->

				<!-- <project-list> -->
				<div class="table-responsive mt-2">    
					<table class="table mb-0 overflow-hidden fs--1 fw-400 text-body text-center">
						<thead>
							<tr>
								<th class="align-middle text-left" style="padding-left:65px;">Project</th>
								<th class="align-middle d-none d-md-block" style="min-width:90px;">Created by</th>
								<th class="align-middle">Status</th>
								<th class="align-middle">Membership</th>
								<th class="align-middle d-none d-lg-block" style="min-width:90px;">Members</th>
								<th class="align-middle"></th>
							</tr>						
						</thead>
						
						<tbody class="border-top">
				
						{% for project in project_list_active %}
							<!-- <membership-active> -->
							<tr>
								<td class="align-middle text-left">
									<div class="d-flex align-items-center">
										<a href="{% url 'projects:single' slug=project.project__slug %}">
											<div class="avatar-icon position-relative d-inline-block my-2">
												<div class="avatar-name position-absolute h-100 w-100 d-block text-center text-uppercase text-white fs--2 fw-700 rounded-circle">
													<span class="position-absolute top-50 start-50 translate-middle">{{ project.project__name.0 }}</span>
												</div>
											</div>
										</a>
										<!-- large screen -->
										<div class="flex-1 align-self-center ps-3 pt-1 d-none d-lg-block">
											<h6 class="fs-0 mb-1">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
											<span class="d-none d-lg-block">
												{% with description=project.project__description_html|capfirst %}
													{{description|safe}}
												{% endwith %}
											</span>
										</div>
										<!-- small screen -->
										<div class="flex-1 align-self-center ps-3 pt-2 d-lg-none">
											<h6 class="fs-0">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
										</div>
									</div>
								</td>
								<td class="align-middle d-none d-md-table-cell">
									{{ project.project__owner__username }}
								</td>
								<td class="align-middle">
									{% if project.project__is_approved == True %}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Active project">
											<small class="fa fa-check-circle text-primary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% else %}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Waiting for approval">
											<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% endif %}
								</td>
								<td class="align-middle">
									<span data-bs-toggle="tooltip" data-bs-placement="top" title="Active member">
										<small class="fa fa-check-circle text-success" data-fa-transform="shrink-4 down-2"></small>
									</span> 
								</td>
								<td class="align-middle d-none d-lg-table-cell">
									<span class="me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Active members">
										<span class="i-active">{{ project.active_members }}</span>
									</span>
									<span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="In process">
										<span class="i-inprocess">{{ project.inactive_members }}</span>
									</span>
								</td>
								{% if project.project__owner__username == request.user.username %}
								<td class="align-middle pe-0">
									<form id="form-active{{ forloop.counter }}" class="my-1 float-end" action="" method="POST">
										{% csrf_token %} 
										<select id="active{{ forloop.counter }}" data-slug="{{project.project__slug}}" class="form-select form-select-sm px-2 bg-transparent text-body" style="width:105px;" onChange=selectChange(this)>
											<option>Action</option>
											<option value="update">Update</option>
											<option value="delete">Delete</option>
										</select>
									</form>
								</td>
								{% else %}
									{% for manager in project_list_manager %}
										{% if manager.project == project.project__pk %}
											{% if manager.is_manager %}
												<td class="align-middle pe-0">
													<form id="form-active{{ forloop.counter }}" class="my-1 float-end" action="" method="POST">
														{% csrf_token %} 
														<select id="active{{ forloop.counter }}" data-slug="{{project.project__slug}}" class="form-select form-select-sm px-2 bg-transparent text-body" style="width:105px;" onChange=selectChange(this)>
															<option>Action</option>
															<option value="update">Update</option>
															<option value="delete">Delete</option>
														</select>
													</form>
												</td>
											{% else %}
												<td class="align-middle pe-0">
													<form id="form-active{{ forloop.counter }}" class="my-1 float-end" action="" method="POST">
														{% csrf_token %} 
														<select id="active{{ forloop.counter }}" data-slug="{{project.project__slug}}" class="form-select form-select-sm px-2 bg-transparent text-body" style="width:105px;" onChange=selectChange(this)>
															<option>Action</option>
															<option value="leave">Leave</option>
														</select>
													</form>
												</td>
											{% endif %}
										{% endif %}
									{% endfor %}
								{% endif %}
							</tr>	
							{% empty %}
							{% if project_list_received.count == 0 and project_list_requested.count == 0 and project_list_waiting.count == 0%}
							<tr>
								<!-- large screen -->
								<td class="align-middle d-none d-lg-table-cell" colspan="5">
									<div class="row flex-center text-center" style="padding: 40px 0;">
										<div class="fs-40 fw-900 text-watermark">No Projects</div>
										<p class="mt-4 mx-auto fs-2 fw-200 text-body">Create a new project or join one</p>
									</div>
								</td>
								<!-- middle screen -->
								<td class="align-middle d-none d-md-table-cell d-lg-none" colspan="4">
									<div class="row flex-center text-center" style="padding: 40px 0;">
										<div class="fs-30 fw-900 text-watermark">No Projects</div>
										<p class="mt-4 mx-auto fs-0 fw-200 text-body">Create a new project or join one</p>
									</div>
								</td>
								<!-- small screen -->
								<td class="align-middle d-md-none" colspan="3">
									<div class="row flex-center text-center" style="padding: 40px 0;">
										<div class="fs-20 fw-900 text-watermark">No Projects</div>
										<p class="mt-4 mx-auto fs-1 fw-200 text-body">Create a new project or join one</p>
									</div>
								</td>
							</tr>
							{% endif %}
							<!-- </membership-active> -->
						{% endfor %}
						
						{% for project in project_list_received %}
							<!-- <membership-received> -->
							<tr>
								<td class="align-middle text-left">

									<div class="d-flex align-items-center">
										<a href="{% url 'projects:single' slug=project.project__slug %}">
											<div class="avatar-icon position-relative d-inline-block my-2">
												<div class="avatar-name position-absolute h-100 w-100 d-block text-center text-uppercase text-white fs--2 fw-700 rounded-circle">
													<span class="position-absolute top-50 start-50 translate-middle">{{ project.project__name.0 }}</span>
												</div>
											</div>
										</a>
										<!-- large screen -->
										<div class="flex-1 align-self-center ps-3 pt-1 d-none d-lg-block">
											<h6 class="fs-0 mb-1">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
											<span class="d-none d-lg-block">
												{% with description=project.project__description_html|capfirst %}
													{{description|safe}}
												{% endwith %}
											</span>
										</div>
										<!-- small screen -->
										<div class="flex-1 align-self-center ps-3 pt-2 d-lg-none">
											<h6 class="fs-0">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
										</div>
									</div>
								</td>
								<td class="align-middle d-none d-md-table-cell">
									{{ project.project__owner__username }}
								</td>
								<td class="align-middle">
									{% if project.project__is_approved == True%}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Active project">
											<small class="fa fa-check-circle text-primary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% else %}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Waiting for approval">
											<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% endif %}
								</td>
								<td class="align-middle">
									<span data-bs-toggle="tooltip" data-bs-placement="top" title="Invitation received">
										<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
									</span> 
								</td>
								<td class="align-middle d-none d-lg-table-cell">
									<span class="me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Active members">
										<span class="i-active">{{ project.active_members }}</span>
									</span>
									<span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="In process">
										<span class="i-inprocess">-</span>
									</span>
								</td>
								<td class="align-middle pe-0">
									<form id="form-received{{ forloop.counter }}" class="my-1 float-end" action="" method="POST">
										{% csrf_token %} 
										<input type="hidden" name="project_pk" value={{project.project__pk}}>
										<select id="received{{ forloop.counter }}" class="form-select form-select-sm px-2 bg-transparent text-body" style="width:105px;" onChange=selectChange(this)>
										 <option>Action</option>
											<option value="accept">Accept</option>
											<option value="reject">Reject</option>
										</select>
									</form>
								</td>
							</tr>	
							<!-- </membership-received> -->
						{% endfor %}
						
						{% for project in project_list_requested %}
							<!-- <membership-requested> -->
							<tr>
							 <td class="align-middle text-left">
									<div class="d-flex align-items-center">
										<a href="{% url 'projects:single' slug=project.project__slug %}">
											<div class="avatar-icon position-relative d-inline-block my-2">
												<div class="avatar-name position-absolute h-100 w-100 d-block text-center text-uppercase text-white fs--2 fw-700 rounded-circle">
													<span class="position-absolute top-50 start-50 translate-middle">{{ project.project__name.0 }}</span>
												</div>
											</div>
										</a>
										<!-- large screen -->
										<div class="flex-1 align-self-center ps-3 pt-1 d-none d-lg-block">
											<h6 class="fs-0 mb-1">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
											<span class="d-none d-lg-block">
												{% with description=project.project__description_html|capfirst %}
													{{description|safe}}
												{% endwith %}
											</span>
										</div>
										<!-- small screen -->
										<div class="flex-1 align-self-center ps-3 pt-2 d-lg-none">
											<h6 class="fs-0">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
										</div>
									</div>
								</td>
								<td class="align-middle d-none d-md-table-cell">
									{{ project.project__owner__username }}
								</td>
								<td class="align-middle">
									{% if project.project__is_approved == True%}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Active project">
											<small class="fa fa-check-circle text-primary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% else %}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Waiting for approval">
											<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% endif %}
								</td>
								<td class="align-middle">
									<span data-bs-toggle="tooltip" data-bs-placement="top" title="Invitation requested">
										<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
									</span> 
								</td>
								<td class="align-middle d-none d-lg-table-cell">
									<span class="me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Active members">
										<span class="i-active">{{ project.active_members }}</span>
									</span>
									<span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="In process">
										<span class="i-inprocess">-</span>
									</span>
								</td>
								<td class="align-middle pe-0">
									<form id="form-requested{{ forloop.counter }}" class="my-1 float-end" action="" method="POST">
										{% csrf_token %} 
										<input type="hidden" name="project_pk" value={{project.project__pk}}>
										<select id="requested{{ forloop.counter }}" class="form-select form-select-sm px-2 bg-transparent text-body" style="width:105px;" onChange=selectChange(this)>
											<option>Action</option>
											<option value="cancel">Cancel</option>
										</select>
									</form>
								</td>
							</tr>	
							<!-- </membership-requested> -->
						{% endfor %}
						
						{% for project in project_list_waiting %}
							<!-- <membership-waiting> -->
							<tr>
								<td class="align-middle text-left">
									<div class="d-flex align-items-center">
										<a href="{% url 'projects:single' slug=project.project__slug %}">
											<div class="avatar-icon position-relative d-inline-block my-2">
												<div class="avatar-name position-absolute h-100 w-100 d-block text-center text-uppercase text-white fs--2 fw-700 rounded-circle">
													<span class="position-absolute top-50 start-50 translate-middle">{{ project.project__name.0 }}</span>
												</div>
											</div>
										</a>
										<!-- large screen -->
										<div class="flex-1 align-self-center ps-3 pt-1 d-none d-lg-block">
											<h6 class="fs-0 mb-1">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
											<span class="d-none d-lg-block">
												{% with description=project.project__description_html|capfirst %}
													{{description|safe}}
												{% endwith %}
											</span>
										</div>
										<!-- small screen -->
										<div class="flex-1 align-self-center ps-3 pt-2 d-lg-none">
											<h6 class="fs-0">
												<a href="{% url 'projects:single' slug=project.project__slug %}">{{ project.project__name | capfirst}}</a>
											</h6>
										</div>
									</div>
								</td>
								<td class="align-middle d-none d-md-table-cell">
									{{ project.project__owner__username }}
								</td>
								<td class="align-middle">
									{% if project.project__is_approved == True%}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Active project">
											<small class="fa fa-check-circle text-primary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% else %}
										<span data-bs-toggle="tooltip" data-bs-placement="top" title="Waiting for approval">
											<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
										</span> 
									{% endif %}
								</td>
								<td class="align-middle">
									<span data-bs-toggle="tooltip" data-bs-placement="top" title="Waiting for approval">
										<small class="fa fa-minus-circle text-secondary" data-fa-transform="shrink-4 down-2"></small>
									</span> 
								</td>
								<td class="align-middle d-none d-lg-table-cell">
									<span class="me-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Active members">
										<span class="i-active">{{ project.active_members }}</span>
									</span>
									<span class="ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="In process">
										<span class="i-inprocess">-</span>
									</span>
								</td>
								<td class="align-middle pe-0">
									<form id="form-waiting{{ forloop.counter }}" class="my-1 float-end" action="" method="POST">
										{% csrf_token %} 
										<input type="hidden" name="project_pk" value={{project.project__pk}}>
										<select id="waiting{{ forloop.counter }}" class="form-select form-select-sm px-2 bg-transparent text-body" style="width:105px;" onChange=selectChange(this)>
											<option>Action</option>
											<option value="cancel">Cancel</option>
										</select>
									</form>
								</td>
							</tr>
							<!-- </membership-waiting> -->	
						{% endfor %}
						
						</tbody>
					</table>
				</div>
				<!-- </project-list> -->		

			</div>
			<!-- </card-body> -->
				
		</div>
 </div>
</div>
{% endblock project_content %}


{% block project_footer %}
<script>
	function JoinProjectURL(){
		if(document.getElementById("project-url").value){
			var project_url = "{% url 'projects:single' slug=' '%}";
			// remove last 4 characters of empty slug, i.e., ' ' == %20/, and then add the project slug
			project_url = project_url.slice(0, -4) + document.getElementById("project-url").value;
			location.href = project_url;
		}
		
		return false;
	}
</script>

<script>
	// actions: accept, reject, cancel, update, delete
	function selectChange(select) {
		var selectID = select.id;
		var value = select.value;
		
		if ($('#'+selectID).data('slug')) {
			var my_slug = $('#'+selectID).data('slug');
			var my_url_update = "{% url 'projects:project-update' slug=12345 %}".replace(/12345/, my_slug.toString());
			var my_url_leave = "{% url 'projects:leave' slug=12345 %}".replace(/12345/, my_slug.toString());
			var my_url_delete = "{% url 'projects:project-delete' slug=12345 %}".replace(/12345/, my_slug.toString());
		}
		
		if(value == 'accept'){
			$("#form-"+selectID).attr("action", "{% url 'projects:accept-invite' %}");
			$("#form-"+selectID).submit();
		}
		else if (value == 'reject' || value == 'cancel'){
			$("#form-"+selectID).attr("action", "{% url 'projects:reject-invite' %}");
			$("#form-"+selectID).submit();
		}
		else if (value == 'update'){
			$("#form-"+selectID).attr("action", my_url_update);
			$("#form-"+selectID).submit();
		}
		else if (value == 'leave'){
			$("#form-"+selectID).attr("action", my_url_leave);
			$("#form-"+selectID).submit();
		}
		else if (value == 'delete'){
			$("#form-"+selectID).attr("action", my_url_delete);
			$("#form-"+selectID).submit();
		} 
	}
</script>
{% endblock project_footer %}
