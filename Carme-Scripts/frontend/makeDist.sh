#!/bin/bash
#-----------------------------------------------------------------------------------------------------------------------------------
# script to freeze Python scripts into executables
#-----------------------------------------------------------------------------------------------------------------------------------


#bash set buildins -----------------------------------------------------------------------------------------------------------------
set -e
set -o pipefail
#-----------------------------------------------------------------------------------------------------------------------------------


# define function die that is called if a command fails ----------------------------------------------------------------------------
function die () {
  echo "ERROR: ${1}"
  exit 200
}
#-----------------------------------------------------------------------------------------------------------------------------------


# check if bash is used to execute the script --------------------------------------------------------------------------------------
[[ ! "$BASH_VERSION" ]] && die "This is a bash-script. Please use bash to execute it!"
#-----------------------------------------------------------------------------------------------------------------------------------


# check if root executes this script -----------------------------------------------------------------------------------------------
[[ ! "$(whoami)" = "root" ]] && die "you need root privileges to run this script"
#-----------------------------------------------------------------------------------------------------------------------------------


# remove previous executables if they exist ----------------------------------------------------------------------------------------
mapfile -t DIST_FOLDERS < <(find . -maxdepth 1 -name "dist_*")
for DIST_FODLER in "${DIST_FOLDERS[@]}";do
  echo "remove ${DIST_FODLER}"
  rm -r "${DIST_FODLER}" || die "cannot remove ${DIST_FODLER}"
done
echo ""
#-----------------------------------------------------------------------------------------------------------------------------------


# create executables ---------------------------------------------------------------------------------------------------------------
mapfile -t PYTHON_FILES < <(find . -maxdepth 1 -name "*.py" | cut -d'/' -f 2)
for FILE in "${PYTHON_FILES[@]}";do
  echo "create executable of ${FILE}"
  BASE_NAME=$(basename "${FILE}" .py)
  cxfreeze "${FILE}" --target-dir dist_"${BASE_NAME}" || die "cannot create dist_${BASE_NAME}"
done
#-----------------------------------------------------------------------------------------------------------------------------------
